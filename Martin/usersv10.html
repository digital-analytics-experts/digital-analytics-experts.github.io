<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Analytics Users</title>
</head>
<body>



<h1 id="login">You are not logged in. Please log in.</h1>

<button id="auth-button" hidden>Login</button>

<button id="users-button" hidden>download users</button>


<!-- <div id="page-wrapper">
  <div>
    <input type="file" id="fileInput" accept=".csv"></input>
  </div>

  <button id="delete-button" hidden>import users for deletion</button>
</div> -->

<div id="remove-emails" hidden>

<input type='file' id="delete-button" accept='text/plain' hidden><br>
<h3>Please select csv file</h3>



</div>

<div id="show">


</div>

<button id="confirm-button" hidden>confirm action</button>

<script>

  // Replace with your client ID from the developer console.
  var CLIENT_ID = '733015638140-da8nkpm0rj9qtnvogslciginfcv3631a.apps.googleusercontent.com';
  
  var accountIds = [];
  var myArray = [];
  var newArray = [];
  var myEmails;
  var nextAccountId;
  var myEmail;
  var xyz;
  var abc;
  var fileArray;
  var fileInput;
  var makeRequest;
  var idArray = [];
  var updateEmails = [];

  // Set authorized scope.
  
  var SCOPES = ['https://www.googleapis.com/auth/analytics.manage.users.readonly','https://www.googleapis.com/auth/analytics.readonly','https://www.googleapis.com/auth/analytics.manage.users'];
  
  	  var confirmButton = document.getElementById('confirm-button');


  function authorize(event) {
    // Handles the authorization flow.
    // `immediate` should be false when invoked from the button click.
    var useImmdiate = event ? false : true;
    var authData = {
      client_id: CLIENT_ID,
      scope: SCOPES,
      immediate: useImmdiate
    };

    gapi.auth.authorize(authData, function(response) {
      var authButton = document.getElementById('auth-button');
	  var usersButton = document.getElementById('users-button');
	  var deleteButton = document.getElementById('delete-button');
	  var removeEmails = document.getElementById('remove-emails');
	  // var confirmButton = document.getElementById('confirm-action');
      if (response.error) {
        authButton.hidden = false;
        usersButton.hidden = true;
		deleteButton.hidden = true;
		removeEmails.hidden = true;
		confirmButton.hidden = true
      }
      else {
        authButton.hidden = true;
		usersButton.hidden = false;
		deleteButton.hidden = false;
		removeEmails.hidden = false;
		// confirmButton.hidden = true;
		document.getElementById("login").textContent = "Welcome, you are logged in";
        // queryAccounts();
      }
    });
  }
  
  
  function downloadUsers(event) {
  makeRequest = "downloadUsers";
  queryAccounts();
  
  	setTimeout(duplicates, 3000);
	setTimeout(validateEmail, 3200);
	setTimeout(downloadtxt, 3500);
  
  }
  
  
  function downloadtxt() {
  
  	  	xyz = myArray.toString();
	// console.log(xyz);
	
	// xyz.replace(" ", "");
	
	  // console.log(abc);


// var myemails = myArray.join(',');
var myemails = newArray.join(';');

var hiddenElement = document.createElement('a');

hiddenElement.href = 'data:attachment/text,' + encodeURI(myemails);
hiddenElement.target = '_blank';
hiddenElement.download = 'myFile.txt';
hiddenElement.click();

newArray.length = 0;

}

// get list of account Ids
function queryAccounts() {
  // Load the Google Analytics client library.
  gapi.client.load('analytics', 'v3').then(function() {

    // Get a list of all Google Analytics accounts for this user
    gapi.client.analytics.management.accounts.list().then(handleAccounts);
  });
}

// get items for each account
function handleAccounts(response) {
  // Handles the response from the accounts list method.
  if (response.result.items && response.result.items.length) {
    // Get the Google Analytics accounts.
	
	for(i = 0; i < response.result.items.length; i++)
	{
	
	accountIds.push(response.result.items[i].id);
	// store account IDs in array
	nextAccountId = response.result.items[i].id;
	
	// if(request == "downloadUsers")	
	queryNextAccounts(nextAccountId);
	
	// var xyz = newArray.toString();
	// console.log(xyz);
	}
	
	// duplicates();
	// setTimeout(duplicates, 3000);
	// setTimeout(validateEmail, 3200);
	// setTimeout(downloadtxt, 3500);
	// downloadtxt();

	
  } else {
    console.log('No accounts found for this user.');
  }
}


// get list of users from account
function queryNextAccounts(accountId) {
	  // console.log(accountId);
  // Get a list of all the emails for the account.
  gapi.client.analytics.management.accountUserLinks.list(
      {'accountId': accountId})
    .then(handleProperties)
    .then(null, function(err) {
      // Log any errors.
      console.log(err);
  });
}

function searchEmails(){

// console.log("function called");

var emailCheck = [];

// split each variable in array

	for(b = 0; b < idArray.length; b++) {

	emailCheck = idArray[b].split(" ");
	
	emailCheck[0].trim();
	if(emailCheck[1])
	emailCheck[1].trim();
	emailCheck[2].trim();
	
	/* console.log("emailcheck[0] = ", emailCheck[0]);
	console.log("emailcheck[1] = ", emailCheck[1]); */
	
		for(c = 0; c < fileArray.length; c++) {
		fileArray[c].trim();
		// console.log("fileArray[c] = ", fileArray[c]);
		
			if(fileArray[c].includes(emailCheck[1]) && fileArray[c] != undefined && emailCheck[1] != undefined) {
				console.log("found match",idArray[b], fileArray[c], emailCheck[1]);
				updateEmails.push(idArray[b]);
				c = fileArray.length + 1;
				}
		
		}
		
		emailCheck.length = 0;
	}
	
	// console.log(idArray.toString());
	
	// emailCheck = emailCheck.filter(function(entry) { return entry.trim() != ' '; });
	
	/* console.log("emailcheck[0] = ", emailCheck[0]);
	console.log("emailcheck[1] = ", emailCheck[1]);
	console.log("emailcheck[2] = ", emailCheck[2]); */
	
	/* if(emailCheck[1] == emailCheck[2]) {
		// console.log("match found: ", emailCheck[1]);
		} */
	/* else
		emailCheck.length = 0;
	} */


// look for match.


// if match not found then remove from array

// emailCheck.length = 0;

// console.log("matched emails found: ",updateEmails.toString());
// console.log("idArray[0]: ",idArray[0]);
// console.log("fileArray[0]: ",fileArray[0]);


// console.log("idArray okay at searchEmails: ", idArray.toString());

}

// get items from account
function handleProperties(response) {
  // Handles the response from the webproperties list method.
  if (response.result.items && response.result.items.length) {
	
	 // var accountLinks = results.items;
	for(i = 0; i < response.result.items.length; i++)
	{
	  
	  
	  if(makeRequest == "downloadUsers") {
	  
		var realValue = response.result.items[i].userRef.email;
		myArray.push(realValue);
	  
	  }
	  
	  else if(makeRequest == "deleteUsers") {
	  
		  var realAccount = response.result.items[i].entity.accountRef.id;
		  var realValue = response.result.items[i].userRef.email;
		  // var realAccount = response.result.items[i].id;
		  // var realUserId = response.result.items[i].entity.accountUserLink.id;
		  var realUserId = response.result.items[i].id;
		  var realName = response.result.items[i].entity.accountRef.name;
		  
		  // console.log("real user id: ",realUserId)
		  
		  realName.trim();
		  
		  
			  
		  idArray.push(realAccount + " " + realValue + " " + realUserId + " " + realName);	 
		  // console.log("idArray: ",idArray.toString());		  
	  }
	  

	  

	  
	  /* var realValue = response.result.items[i].userRef.email;
	  var realAccount = response.result.items[i].entity.accountRef.id;
	  // var realAccount = response.result.items[i].id;
	  // var realUserId = response.result.items[i].entity.accountUserLink.id;
	  var realUserId = response.result.items[i].userRef.id;
	  
	  // console.log("real user id: ",realUserId)
	  
	  myArray.push(realValue);
		  
	  idArray.push(realAccount + " " + realValue + " " + realUserId); */
	  
	  // idArray.push(realAccount + " " + realValue);
	  
	  

    }
	
	// xyz = myArray.toString();
	// console.log(xyz);
	
	
	
  } else {
    console.log('No email addresses found for this user.');
  }
  
  // console.log("API account users: ",idArray.toString());
}


function checkUsers() {

var accId, accName, emailId, accStore; 

    var printThis = "";
	
    for(b = 0; b < updateEmails.length; b++) {
	
		accStore = updateEmails[b].split(" ");
		
		accId = accStore[0];
		accName = accStore[3];
		emailId = accStore[1];
		if(accStore[4])
		accName += " "+accStore[4];
		if(accStore[5])
		accName+= " "+accStore[5];
		if(accStore[6])
		accName+= " "+accStore[6];
		if(accStore[7])
		accName+= " "+accStore[7];
		if(accStore[8])
		accName+= "...";
		
        printThis += "<br>"+"<b>Account ID = </b>" + accId + ", <b>Account Name = </b>" + accName + ", <b>Email ID = </b>" + emailId;
		
		// console.log(printThis);
    }
    // return printThis;
	
	document.getElementById("show").innerHTML = printThis;
	
	confirmButton.hidden = false;


	// for each idArray[accountid][email]
	
		/* for(b = 0; b < idArray.length; b++) {

			accStore = idArray[b].split(" ");
			
			accId = accStore[0];
			accName = accStore[4];
			emailId = accStore[1];
	
	
	// show account id, account name, user email, checked checkbox
	
	function register(){
    // caution: drop the "new Array" part or it won't work!
    var ids = ['name','lname','email','password','cpassword'];
    var printThis = "";
    for(var i = 0; i < ids.length; i++){
        printThis += "<br>"+ids[i];
    }
    return printThis; // <-- to be printed to the div
}
document.getElementById('ids').innerHTML = register();


	document.getElementById("show").innerHTML = ("Account ID = " + accId + " , Account Name = " + accName + " , Email ID = " + emailId + "\n");
	
	
	}
	
	// form submit remove unchecked idArray[][email] */
}

function removeUsersAccount() {

var accId, linkId, userEmail;

			  var request = gapi.client.analytics.management.accountUserLinks.list({
				  'accountId': accId
			  });
			  request.execute(function (responseAcc) {  
			  response = responseAcc;

if(response.items.length !== null || response.items.length !== undefined) {

	// on form submit 
	
	// for each updateEmails[accountid][linkId]
	
	    for(b = 0; b < updateEmails.length; b++) {
	
			accStore = updateEmails[b].split(" ");
			
			accId = accStore[0];
			// linkId = accStore[2];
			userEmail = accStore[1];
			
			// see if permission at account level. If so then run delete. Do same for proeprty and profile level
			
			// if email matches email from array, and local permissions are set, get user link id and delete
			
			  var request = gapi.client.analytics.management.accountUserLinks.list({
				  'accountId': accId
			  });
			  request.execute(function (responseAcc) {  
			  response = responseAcc;

				for(a = 0; a < response.items.length; a++)
				{
				
					// check if local permissions for email user
					if(response.items[a].permissions.local !== 'undefined' && response.items[a].permissions.local.length > 0 && response.items[a].userRef.email == userEmail)
					{
						// get userlink id
						linkId = response.items[a].id;
						// console.log("About to change Account level for: ", userEmail);
					
						// remove user
						try{
						
							// function deleteAccountUserLink() {
							
							/* var request = gapi.client.analytics.management.accountUserLinks.delete(
							{
								'accountId': accId,
								'linkId': linkId
							});

								// request.execute(); // (function (response) { console.log("executed: ",linkId)) } // Handle the response. });
								request.execute(function (response) {       console.log("Got callback, response = " + response.result);           });
							// }
							
							// var x = request.execute(); */
							
							// console.log("request: ",linkId);
						
						}
						catch(e){
						
							console.log(linkId + " not removed", e);
						
						}
					}
				}
			
			});
		}
	
	
	// clear updateEmails
	// updateEmails.length = 0;
	
	// show message that users deleted
	document.getElementById("show").innerHTML = "Account action complete. See Console for details";
	}
	
	else {
		console.log("No Porperties found");
	
	}
	
}

function removeUsersProperty() {

var accId, linkId, userEmail, propId;

			  var request = gapi.client.analytics.management.webpropertyUserLinks.list({
			  'accountId': accId,
			  'webPropertyId': '~all',
			  'max-results': 10000
			  });

			  request.execute(function (responseProp) {  
			  response = responseProp;

if(response.items.length !== null || response.items.length !== undefined) {

console.log("updateEmails length at PROPERTY: ", updateEmails.length);

	// on form submit 
	
	// for each updateEmails[accountid][linkId]
	
	    for(b = 0; b < updateEmails.length; b++) {
	
			accStore = updateEmails[b].split(" ");
			
			accId = accStore[0];
			// linkId = accStore[2];
			userEmail = accStore[1];
			
			// see if permission at account level. If so then run delete. Do same for proeprty and profile level
			
			// if email matches email from array, and local permissions are set, get user link id and delete
			
			  var request = gapi.client.analytics.management.webpropertyUserLinks.list({
			  'accountId': accId,
			  'webPropertyId': '~all',
			  'max-results': 10000
			  });

			  request.execute(function (responseProp) {  
			  response = responseProp;
			  
			  // console.log("Response length at PROPERTY: ", response.items.length);

				for(a = 0; a < response.items.length; a++)
				{
				
					// check if local permissions for email user
					if(response.items[a].permissions.local !== 'undefined' && response.items[a].permissions.local.length > 0 && response.items[a].userRef.email == userEmail)
					{
						// get userlink id
						linkId = response.items[a].id;
						console.log("About to change Property level for: ", userEmail);
						
						// get property id
						propId = response.items[a].entity.webPropertyRef.id;
					
						// remove user
						try{
						
							// function deleteAccountUserLink() {
							
							/* var request = gapi.client.analytics.management.webpropertyUserLinks.delete(
							{
								'accountId': accId,
								'webPropertyId': propId,
								'linkId': linkId
							});

								// request.execute(); // (function (response) { console.log("executed: ",linkId)) } // Handle the response. });
								request.execute(function (response) {       console.log("Got callback, response = " + response.result);           });
							// }
							
							// var x = request.execute(); */
							
							// console.log("request: ",linkId);
						
						}
						catch(e){
						
							console.log(linkId + " not removed", e);
						
						}
					}
				}
			
			});
		}
	
	
	// clear updateEmails
	// updateEmails.length = 0;
	
	// show message that users deleted
	document.getElementById("show").innerHTML = "Property action complete. See Console for details";
	}
	
	else {
		console.log("No Porperties found");
	
	}
	
}

function removeUsersProfile() {

var accId, linkId, userEmail, propId, profId;

			 var request = gapi.client.analytics.management.profileUserLinks.list({
				  'accountId': accId,
				  'webPropertyId': '~all',
				  'profileId': '~all'
			  });
			
			  request.execute(function (responseProf) {  
			  response = responseProf;

if(response.items.length !== null || response.items.length !== undefined) {

console.log("updateEmails length at PROFILE: ", updateEmails.length);

	// on form submit 
	
	// for each updateEmails[accountid][linkId]
	
	    for(b = 0; b < updateEmails.length; b++) {
	
			accStore = updateEmails[b].split(" ");
			
			accId = accStore[0];
			// linkId = accStore[2];
			userEmail = accStore[1];
			
			// console.log("Profile user Email: ", userEmail);
			
			// see if permission at account level. If so then run delete. Do same for proeprty and profile level
			
			// if email matches email from array, and local permissions are set, get user link id and delete
			
			 var request = gapi.client.analytics.management.profileUserLinks.list({
				  'accountId': accId,
				  'webPropertyId': '~all',
				  'profileId': '~all'
			  });
			
			  request.execute(function (responseProf) {  
			  response = responseProf;
			  
			  // console.log("Response length at PROFILE: ", response.items.length);

				for(a = 0; a < response.items.length; a++)
				{
				
					// check if local permissions for email user
					if(response.items[a].permissions.local !== 'undefined' && response.items[a].permissions.local.length > 0 && response.items[a].userRef.email == userEmail)
					{
						// get userlink id
						linkId = response.items[a].id;
						console.log("About to change Profile level for: ", userEmail);
						
						// get property id
						propId = response.items[a].entity.profileRef.webPropertyId;
						profId = response.items[a].profileRef.id;
					
						// remove user
						try{
						
							// function deleteAccountUserLink() {
							
							 /* var request = gapi.client.analytics.management.profileUserLinks.delete(
							{
								 'accountId': accId,
								 'webPropertyId': propId,
								 'profileId': profId,
								 'linkId': linkId
							});

								// request.execute(); // (function (response) { console.log("executed: ",linkId)) } // Handle the response. });
								request.execute(function (response) {       console.log("Got callback, response = " + response.result);           });
							// }
							
							// var x = request.execute(); */
							
							// console.log("request: ",linkId);
						
						}
						catch(e){
						
							console.log(linkId + " not removed", e);
						
						}
					}
				}
			
			});
		}
	
	
	// clear updateEmails
	// updateEmails.length = 0;
	
	// show message that users deleted
	document.getElementById("show").innerHTML = "Profile action complete. See Console for details";
	
	}
	
		else {
		console.log("No Profiles found");
	
	}
	
}


function duplicates() {

var compare;
var compareme;

	// console.log("idArray okay at duplicates: ", idArray.toString());

if(makeRequest == "deleteUsers")
	myArray = idArray;

myArray.sort();

for(i = 0; i < myArray.length; i++)
{

	compare = myArray[i];
	compareme = 0;

	for(x = 0; x < myArray.length; x++)
	{
		if (myArray[x] == compare)
		{
			compareme ++;
			if(compareme > 1) {
			// myArray.splice(x,1);
				myArray[x] = "";
				}
			
			}

	}

}


myArray = myArray.filter(function(entry) { return entry.trim() != ''; });

if(makeRequest == "deleteUsers")
	idArray = myArray;
	
 
}

function validateEmail()
{

	var patt = new RegExp("@dyson.com");

	for(i = 0; i < myArray.length; i++)
	{

		if(patt.test(myArray[i]))
		newArray.push(myArray[i]);
		

	}

}

function deleteUsers(event){
	makeRequest = "deleteUsers";
    var input = event.target;

    var reader = new FileReader();
    reader.onload = function(){
      // var text = reader.result;
	  fileInput = reader.result;
	  
	  fileArray = fileInput.split("\n");
      // console.log(reader.result.substring(0, 200));
	  // console.log("Contents of file: ",fileArray.toString());
	  
	  
	  
	  
	  retrieveUsers()
	  
	// duplicates();
	// searchEmails();
	// checkUsers();
		
	  setTimeout(duplicates, 3000);
	  setTimeout(searchEmails, 3200);
	  setTimeout(checkUsers, 3500);
	  
    };
    reader.readAsText(input.files[0]);
	
	// if(fileArray)
	// {
		// console.log("dat from file: ",fileArray.toString());
	
	// console.log(fileArray[2]);
		// retrieveUsers()
		// console.log(idArray.toString());
		
		// }
		
		// };
  }
  
  function confirmAction(event) {
	// console.log("Confirmed");
	
	setTimeout(removeUsersAccount, 3000);
	setTimeout(removeUsersProperty, 3200);
	setTimeout(removeUsersProfile, 3500);
	// removeUsersAccount();
	// removeUsersProperty();
	// removeUsersProfile();
	
	// updateEmails.length = 0;
	document.getElementById("show").innerHTML = "Action complete. See Console for details";
  
  }
  
  function retrieveUsers() {
  
	  // Load the Google Analytics client library.
  gapi.client.load('analytics', 'v3').then(function() {

    // Get a list of all Google Analytics accounts for this user
    gapi.client.analytics.management.accounts.list().then(handleAccounts);
  });
  
  }
  
  // document.getElementById("login").textContent = "Welcome, you are logged in";


  // Add an event listener to the 'auth-button'.
  document.getElementById('auth-button').addEventListener('click', authorize);
  document.getElementById('users-button').addEventListener('click', downloadUsers);
  document.getElementById('delete-button').addEventListener('change', deleteUsers);
  document.getElementById('confirm-button').addEventListener('click', confirmAction);
</script>

<script src="https://apis.google.com/js/client.js?onload=authorize"></script>

</body>
</html>